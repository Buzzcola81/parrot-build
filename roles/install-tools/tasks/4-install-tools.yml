---
- name: "Install dislocker utility"
  apt:
    name:
      - dislocker
    state: present
  become: true
  become_method: sudo

- name: "Install xfreerdp utility"
  apt:
    name:
      - freerdp2-x11
    state: present
  become: true
  become_method: sudo

- name: Ensure pipx is installed
  apt:
    name: pipx
    state: present
  become: true
  become_method: sudo

- name: Ensure pipx path is set up
  command: pipx ensurepath
  changed_when: false

- name: Install defaultcreds-cheat-sheet with pipx (as normal user)
  command: pipx install --force defaultcreds-cheat-sheet
  become: false
  args:
    creates: "{{ lookup('env','HOME') }}/.local/pipx/venvs/defaultcreds-cheat-sheet"

- name: Install pypykatz with pipx (as normal user)
  command: pipx install --force pypykatz
  become: false
  args:
    creates: "{{ lookup('env','HOME') }}/.local/pipx/venvs/pypykatz"

- name: Install donpapi with pipx (as normal user)
  command: pipx install --force donpapi
  become: false
  args:
    creates: "{{ lookup('env','HOME') }}/.local/pipx/venvs/donpapi"

- name: "Install krb5-user utility"
  apt:
    name:
      - krb5-user
    state: present
  become: true
  become_method: sudo

- name: Install oscrypto with pip3 (as normal user needed for PKINITtools)
  command: pip3 install git+https://github.com/wbond/oscrypto.git --break-system-packages
  become: false

- name: Intall minikerberos (required for PKINITtools)
  command: pip3 install --force minikerberos --break-system-packages
  become: false

- name: "Install libssl-dev (required for PKINITtools)"
  apt:
    name:
      - libssl-dev
    state: present
  become: true
  become_method: sudo

- name: Create libcrypto symbolic link (required for PKINITtools)
  file:
    src: /usr/lib/x86_64-linux-gnu/libcrypto.so.3
    dest: /usr/lib/libcrypto.so
    state: link
    force: yes
  become: true
  become_method: sudo

- name: Update library cache (required for PKINITtools)
  command: ldconfig
  become: yes
